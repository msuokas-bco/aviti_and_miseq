<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Dada2 pipeline for MiSeq and AVITI reads</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="dada2_pipeline_files/libs/clipboard/clipboard.min.js"></script>
<script src="dada2_pipeline_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="dada2_pipeline_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="dada2_pipeline_files/libs/quarto-html/popper.min.js"></script>
<script src="dada2_pipeline_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dada2_pipeline_files/libs/quarto-html/anchor.min.js"></script>
<link href="dada2_pipeline_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dada2_pipeline_files/libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dada2_pipeline_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dada2_pipeline_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dada2_pipeline_files/libs/bootstrap/bootstrap-55afc73cbc461e556647e9b656320d87.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="dada2_pipeline_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="dada2_pipeline_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Dada2 pipeline for MiSeq and AVITI reads</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<script>

document.addEventListener("DOMContentLoaded", function() {
  // Function to get computed color from CSS variables or computed styles
  function getThemeColor(varName, fallback) {
    const root = document.documentElement;
    const color = getComputedStyle(root).getPropertyValue(varName).trim();
    return color || fallback;
  }
  
  // Extract theme colors from Quarto
  const primaryColor = getThemeColor('--bs-primary', '#0d6efd');
  const secondaryColor = getThemeColor('--bs-secondary', '#6c757d');
  const bodyBg = getThemeColor('--bs-body-bg', '#ffffff');
  const bodyColor = getThemeColor('--bs-body-color', '#212529');
  const borderColor = getThemeColor('--bs-border-color', '#dee2e6');
  
  // For striped rows, try to get the striped background color
  const stripedBg = getThemeColor('--bs-table-striped-bg', 'rgba(0, 0, 0, 0.05)');
  
  // Try to get code block background color - using light variant
  const codeBg = getThemeColor('--bs-light', getThemeColor('--bs-light-bg', '#f8f9fa'));
  
  // Log colors for debugging
  console.log('Theme colors:', {
    primary: primaryColor,
    secondary: secondaryColor,
    bodyBg: bodyBg,
    bodyColor: bodyColor,
    border: borderColor,
    striped: stripedBg,
    codeBg: codeBg
  });
  
  // Select all tables (adjust selector as needed)
  const tables = document.querySelectorAll('table.table, .quarto-table table');
  
  tables.forEach(table => {
    // Style table border
    table.style.borderColor = borderColor;
    
    // Style header
    const header = table.querySelector('thead');
    if (header) {
      header.style.backgroundColor = primaryColor;
      header.style.color = '#ffffff'; // Usually white text on primary color
      header.style.borderColor = primaryColor;
      
      // Style header cells
      const headerCells = header.querySelectorAll('th');
      headerCells.forEach(cell => {
        cell.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      });
    }
    
    // Style body rows
    const rows = table.querySelectorAll('tbody > tr');
    rows.forEach((row, index) => {
      if (index % 2 === 0) {
        // Even rows - use stripped background
        row.style.backgroundColor = stripedBg;
      } else {
        // Odd rows - use body background
        row.style.backgroundColor = bodyBg;
      }
      
      // Style cells
      const cells = row.querySelectorAll('td');
      cells.forEach(cell => {
        cell.style.borderColor = borderColor;
        cell.style.color = bodyColor;
      });
    });
    
    // Add hover effect
    table.addEventListener('mouseover', function(e) {
      const row = e.target.closest('tbody tr');
      if (row) {
        row.style.backgroundColor = secondaryColor;
        row.style.color = '#ffffff';
        row.style.transition = 'all 0.2s ease';
      }
    });
    
    table.addEventListener('mouseout', function(e) {
      const row = e.target.closest('tbody tr');
      if (row) {
        const index = Array.from(row.parentElement.children).indexOf(row);
        row.style.backgroundColor = index % 2 === 0 ? stripedBg : bodyBg;
        row.style.color = bodyColor;
      }
    });
  });
  
  // Style code chunks
  console.log('Setting up code chunk styles');
  
  const codeChunks = document.querySelectorAll('div.sourceCode');
  console.log('Found code chunks:', codeChunks.length);
  
  // Create a style element to inject CSS rules
  // We'll use a nice constant light color for background since Quarto's inline style is hard to override
  const styleEl = document.createElement('style');
  styleEl.textContent = `
    div.sourceCode {
      border-left: 4px solid ${primaryColor} !important;
      border-radius: 4px !important;
    }
    
    p code, li code, td code, th code {
      background-color: ${codeBg} !important;
      color: ${primaryColor} !important;
      padding: 0.2em 0.4em !important;
      border-radius: 3px !important;
    }
  `;
  document.head.appendChild(styleEl);
  
  console.log('Code chunk styles injected - border will use theme primary color');
});
</script>
</div>
<p>The workflow is modified from “Dada2 pipeline guide” and “Bioconductor Workflow for Microbiome Data Analysis: from raw reads to community analyses” by Benjamin Callahan.</p>
<p>Read processing part will create separate result directories and files for Aviti and Miseq. Later ASV table are merged together, when data between two platforms are compared.</p>
<p>Prior dada2 processing, forward and reverse primers were trimmed with cutadapt.</p>
<section id="aviti-read-processing" class="level3">
<h3 class="anchored" data-anchor-id="aviti-read-processing">Aviti read processing</h3>
<section id="file-locations-and-variables" class="level4">
<h4 class="anchored" data-anchor-id="file-locations-and-variables">File locations and variables</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Paths</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>aviti <span class="ot">&lt;-</span> <span class="st">"aviti_reads/"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> <span class="st">"~/reference/silva_nr99_v138.2_toGenus_trainset.fa.gz"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> <span class="st">"~/reference/silva_v138.2_assignSpecies.fa.gz"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>aviti_meta <span class="ot">&lt;-</span> <span class="st">"aviti_metadata.tsv"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>aviti_export <span class="ot">&lt;-</span> <span class="st">"aviti_results/"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Creates results directory</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(aviti_export)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>truncation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">260</span>,<span class="dv">200</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>meta_1stcol <span class="ot">&lt;-</span> <span class="st">"Sampleid"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="file-and-sample-lists" class="level4">
<h4 class="anchored" data-anchor-id="file-and-sample-lists">File and sample lists</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#List files sequence files in source directory</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(aviti)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "A153-MITY_F1_TR1.fastq.gz"  "A153-MITY_F1_TR2.fastq.gz" 
 [3] "A154-MITY_F2_TR1.fastq.gz"  "A154-MITY_F2_TR2.fastq.gz" 
 [5] "A155-MITY_F3_TR1.fastq.gz"  "A155-MITY_F3_TR2.fastq.gz" 
 [7] "A156-MITY_P1_TR1.fastq.gz"  "A156-MITY_P1_TR2.fastq.gz" 
 [9] "A157-MITY_P2_TR1.fastq.gz"  "A157-MITY_P2_TR2.fastq.gz" 
[11] "A158-MITY_W1_TR1.fastq.gz"  "A158-MITY_W1_TR2.fastq.gz" 
[13] "A159-MITY_W2_TR1.fastq.gz"  "A159-MITY_W2_TR2.fastq.gz" 
[15] "A160-MITY_W3_TR1.fastq.gz"  "A160-MITY_W3_TR2.fastq.gz" 
[17] "A161-MITY_T1_TR1.fastq.gz"  "A161-MITY_T1_TR2.fastq.gz" 
[19] "A162-MITY_T2_TR1.fastq.gz"  "A162-MITY_T2_TR2.fastq.gz" 
[21] "A163-MITY_WF1_TR1.fastq.gz" "A163-MITY_WF1_TR2.fastq.gz"
[23] "A164-MITY_WF2_TR1.fastq.gz" "A164-MITY_WF2_TR2.fastq.gz"
[25] "A165-MITY_C1_TR1.fastq.gz"  "A165-MITY_C1_TR2.fastq.gz" 
[27] "A166-MITY_Neg_TR1.fastq.gz" "A166-MITY_Neg_TR2.fastq.gz"
[29] "filtered"                  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward read names: SAMPLENAME_TR1.fastq.gz</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>fnFwds <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(aviti, <span class="at">pattern =</span> <span class="st">"_TR1.fastq"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reverse read names: SAMPLENAME_TR2.fastq.gz</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>fnRevs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(aviti, <span class="at">pattern =</span> <span class="st">"_TR2.fastq"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract sample names to the list</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>sample.names <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">basename</span>(fnFwds), <span class="st">"-"</span>), <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="read-quality-plots" class="level4">
<h4 class="anchored" data-anchor-id="read-quality-plots">Read quality plots</h4>
<p>Read quality from aggregated sequence data (200 000)</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>qfwd <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(fnFwds, <span class="at">aggregate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n =</span> <span class="fl">2e05</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(qfwd, <span class="at">file =</span> <span class="fu">paste0</span>(aviti_export, <span class="st">"qfwd.rds"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>qrev <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(fnRevs, <span class="at">aggregate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n =</span> <span class="fl">2e05</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(qrev, <span class="at">file =</span> <span class="fu">paste0</span>(aviti_export, <span class="st">"qrev.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plot forward and reverse read qualities. Data can be used to evaluate proper truncation length for filter and trim step.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>qfwd <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"qfwd.rds"</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>qrev <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"qrev.rds"</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>qfwd <span class="ot">&lt;-</span> qfwd <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Forward reads"</span>) <span class="sc">+</span> <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>qrev <span class="ot">&lt;-</span> qrev <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Reverse reads"</span>) <span class="sc">+</span> <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>qfwd <span class="sc">+</span> qrev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/aviti_qplots-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p></p>
</section>
<section id="filter-and-trim-reads" class="level4">
<h4 class="anchored" data-anchor-id="filter-and-trim-reads">Filter and trim reads</h4>
<p>Create output lists for trim and filter function</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtered read files are placed in filtered subdirectory</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>filtFwds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(aviti, <span class="st">"filtered"</span>, <span class="fu">paste0</span>(sample.names,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"_F_filt.fastq.gz"</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>filtRevs <span class="ot">&lt;-</span> <span class="fu">file.path</span>(aviti, <span class="st">"filtered"</span>, <span class="fu">paste0</span>(sample.names,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"_R_filt.fastq.gz"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Execute the function</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Default parameters except truncLen and multithread</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">filterAndTrim</span>(fnFwds, filtFwds, fnRevs, filtRevs,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">truncLen =</span> truncation,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">maxN =</span> <span class="dv">0</span>, <span class="at">maxEE =</span> <span class="dv">2</span>, <span class="at">truncQ =</span> <span class="dv">2</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">compress =</span> <span class="cn">TRUE</span>, <span class="at">multithread =</span> <span class="dv">8</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">rm.phix =</span> phi)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save output object to file</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(out, <span class="fu">paste0</span>(aviti_export, <span class="st">"out.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="learn-error-rates" class="level4">
<h4 class="anchored" data-anchor-id="learn-error-rates">Learn error rates</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward read error rate</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>errFwd <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtFwds, <span class="at">multithread =</span> <span class="dv">8</span>, <span class="at">randomize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reverse read error rate</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>errRev <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtRevs, <span class="at">multithread =</span> <span class="dv">8</span>, <span class="at">randomize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># save objects to files</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errFwd, <span class="fu">paste0</span>(aviti_export, <span class="st">"errFwd.rds"</span>))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errRev, <span class="fu">paste0</span>(aviti_export, <span class="st">"errRev.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plot error profiles</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>errFwd <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"errFwd.rds"</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot error rate profile for forward reads</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>plot_fwd <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errFwd, <span class="at">nominalQ=</span><span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">ggtitle</span> (<span class="st">"Forward"</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>errRev <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"errRev.rds"</span>))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot error rate profile for reverse reads</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>plot_rev <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errRev, <span class="at">nominalQ=</span><span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Reverse"</span>) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>plot_fwd<span class="sc">/</span>plot_rev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/aviti_eplot-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p></p>
</section>
<section id="denoise-reads" class="level4">
<h4 class="anchored" data-anchor-id="denoise-reads">Denoise reads</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Denoise both forward and reverse reverse read using error rate profiles</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dadaFwds <span class="ot">&lt;-</span> <span class="fu">dada</span>(filtFwds, <span class="at">err =</span> errFwd, <span class="at">multithread =</span> <span class="dv">8</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>dadaRevs <span class="ot">&lt;-</span> <span class="fu">dada</span>(filtRevs, <span class="at">err =</span> errRev, <span class="at">multithread =</span> <span class="dv">8</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save objects to files</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dadaFwds, <span class="fu">paste0</span>(aviti_export, <span class="st">"dadaFwds.rds"</span>))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dadaRevs, <span class="fu">paste0</span>(aviti_export, <span class="st">"dadaRevs.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="merge-reads" class="level4">
<h4 class="anchored" data-anchor-id="merge-reads">Merge reads</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dadaFwds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"dadaFwds.rds"</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dadaRevs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"dadaRevs.rds"</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge denoised paired-end reads</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">mergePairs</span>(dadaFwds, filtFwds, dadaRevs, filtRevs,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object to a file</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(merged, <span class="fu">paste0</span>(aviti_export, <span class="st">"merged.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="build-asv-table" class="level4">
<h4 class="anchored" data-anchor-id="build-asv-table">Build ASV table</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"merged.rds"</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sequence table. Rownames are sequences, colnames samples</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>seqtab <span class="ot">&lt;-</span> <span class="fu">makeSequenceTable</span>(merged)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions of ASV table</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(seqtab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   14 6516</code></pre>
</div>
</div>
<p></p>
<p>Remove chimeric variants</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove chimeras</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">removeBimeraDenovo</span>(seqtab, <span class="at">method =</span> <span class="st">"consensus"</span>,                                    <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(seqtab.nochim)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object to file</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(seqtab.nochim, <span class="fu">paste0</span>(aviti_export, <span class="st">"seqtabnochim.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plot ASV length distribution ( relative abundance is not accounted for).</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"seqtabnochim.rds"</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect sequence length distributions</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>asv_lengths <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">length =</span> <span class="fu">nchar</span>(<span class="fu">colnames</span>(seqtab.nochim)))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(asv_lengths, <span class="fu">aes</span>(<span class="at">x =</span> length)) <span class="sc">+</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"orangered"</span>) <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ASV kength Distribution"</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Merged Length (nt)"</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"No of Reads"</span>) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">300</span>,<span class="dv">500</span>) <span class="sc">+</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/aviti_asv_length-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p></p>
</section>
<section id="a-denoising-summary-table" class="level4">
<h4 class="anchored" data-anchor-id="a-denoising-summary-table">A denoising summary table</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read all objects from files</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"out.rds"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>dadaFwds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"dadaFwds.rds"</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>dadaRevs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"dadaRevs.rds"</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"merged.rds"</span>))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"seqtabnochim.rds"</span>))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get values for each sample</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>getN <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">getUniques</span>(x))</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>track <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out, <span class="fu">sapply</span>(dadaFwds, getN), <span class="fu">sapply</span>(dadaRevs, getN),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>               <span class="fu">sapply</span>(merged, getN), <span class="fu">rowSums</span>(seqtab.nochim),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rowSums</span>(seqtab.nochim <span class="sc">!=</span> <span class="dv">0</span>))</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># If processing a single sample, remove the sapply calls: e.g.</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># replace sapply(dadaFs, getN) with getN(dadaFs)</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace column names</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(track) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Input"</span>, <span class="st">"Filtered"</span>, <span class="st">"DenoisedF"</span>, <span class="st">"DenoisedR"</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Merged"</span>, <span class="st">"Non-chimeric"</span>,<span class="st">"Variants"</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace row names</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(track) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Table</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(track, <span class="at">format =</span> <span class="st">"html"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Input</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Filtered</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DenoisedF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DenoisedR</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Merged</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Non-chimeric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Variants</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A153</td>
<td style="text-align: right;">591561</td>
<td style="text-align: right;">478305</td>
<td style="text-align: right;">477352</td>
<td style="text-align: right;">478109</td>
<td style="text-align: right;">459967</td>
<td style="text-align: right;">450737</td>
<td style="text-align: right;">1698</td>
</tr>
<tr class="even">
<td style="text-align: left;">A154</td>
<td style="text-align: right;">321204</td>
<td style="text-align: right;">264655</td>
<td style="text-align: right;">264324</td>
<td style="text-align: right;">264617</td>
<td style="text-align: right;">253606</td>
<td style="text-align: right;">250899</td>
<td style="text-align: right;">382</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A155</td>
<td style="text-align: right;">664599</td>
<td style="text-align: right;">525969</td>
<td style="text-align: right;">524602</td>
<td style="text-align: right;">525774</td>
<td style="text-align: right;">494739</td>
<td style="text-align: right;">483766</td>
<td style="text-align: right;">1597</td>
</tr>
<tr class="even">
<td style="text-align: left;">A156</td>
<td style="text-align: right;">532500</td>
<td style="text-align: right;">433267</td>
<td style="text-align: right;">432972</td>
<td style="text-align: right;">433063</td>
<td style="text-align: right;">416381</td>
<td style="text-align: right;">410790</td>
<td style="text-align: right;">967</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A157</td>
<td style="text-align: right;">599747</td>
<td style="text-align: right;">481750</td>
<td style="text-align: right;">480739</td>
<td style="text-align: right;">481533</td>
<td style="text-align: right;">468731</td>
<td style="text-align: right;">463346</td>
<td style="text-align: right;">1091</td>
</tr>
<tr class="even">
<td style="text-align: left;">A158</td>
<td style="text-align: right;">422882</td>
<td style="text-align: right;">294874</td>
<td style="text-align: right;">294819</td>
<td style="text-align: right;">294830</td>
<td style="text-align: right;">280157</td>
<td style="text-align: right;">275256</td>
<td style="text-align: right;">240</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A159</td>
<td style="text-align: right;">264889</td>
<td style="text-align: right;">220798</td>
<td style="text-align: right;">220564</td>
<td style="text-align: right;">220787</td>
<td style="text-align: right;">208447</td>
<td style="text-align: right;">207395</td>
<td style="text-align: right;">188</td>
</tr>
<tr class="even">
<td style="text-align: left;">A160</td>
<td style="text-align: right;">55601</td>
<td style="text-align: right;">44312</td>
<td style="text-align: right;">44293</td>
<td style="text-align: right;">44277</td>
<td style="text-align: right;">42934</td>
<td style="text-align: right;">42928</td>
<td style="text-align: right;">31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A161</td>
<td style="text-align: right;">310866</td>
<td style="text-align: right;">216786</td>
<td style="text-align: right;">216630</td>
<td style="text-align: right;">216746</td>
<td style="text-align: right;">209419</td>
<td style="text-align: right;">208228</td>
<td style="text-align: right;">268</td>
</tr>
<tr class="even">
<td style="text-align: left;">A162</td>
<td style="text-align: right;">674269</td>
<td style="text-align: right;">535796</td>
<td style="text-align: right;">534905</td>
<td style="text-align: right;">535658</td>
<td style="text-align: right;">509770</td>
<td style="text-align: right;">504685</td>
<td style="text-align: right;">630</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A163</td>
<td style="text-align: right;">791536</td>
<td style="text-align: right;">614452</td>
<td style="text-align: right;">613752</td>
<td style="text-align: right;">614129</td>
<td style="text-align: right;">595589</td>
<td style="text-align: right;">588487</td>
<td style="text-align: right;">941</td>
</tr>
<tr class="even">
<td style="text-align: left;">A164</td>
<td style="text-align: right;">534436</td>
<td style="text-align: right;">426269</td>
<td style="text-align: right;">426023</td>
<td style="text-align: right;">426139</td>
<td style="text-align: right;">419326</td>
<td style="text-align: right;">416615</td>
<td style="text-align: right;">489</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A165</td>
<td style="text-align: right;">2746</td>
<td style="text-align: right;">2152</td>
<td style="text-align: right;">2122</td>
<td style="text-align: right;">2132</td>
<td style="text-align: right;">1999</td>
<td style="text-align: right;">1999</td>
<td style="text-align: right;">62</td>
</tr>
<tr class="even">
<td style="text-align: left;">A166</td>
<td style="text-align: right;">2853</td>
<td style="text-align: right;">1427</td>
<td style="text-align: right;">1418</td>
<td style="text-align: right;">1418</td>
<td style="text-align: right;">1418</td>
<td style="text-align: right;">1418</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p></p>
</section>
<section id="assign-taxonomy" class="level4">
<h4 class="anchored" data-anchor-id="assign-taxonomy">Assign taxonomy</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"seqtabnochim.rds"</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign taxa up to genus level</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">assignTaxonomy</span>(seqtab.nochim, training, <span class="at">multithread =</span> <span class="dv">10</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign species that are perfectly matched </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">addSpecies</span>(taxa, species)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object to a file</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(taxa, <span class="fu">paste0</span>(aviti_export, <span class="st">"taxa.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="treesummarizedexperiment-object" class="level4">
<h4 class="anchored" data-anchor-id="treesummarizedexperiment-object">TreeSummarizedExperiment object</h4>
<p>The object can hold all necessary information needed for microbiome data analysis.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read project metadata file</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>samples_meta <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(aviti_meta)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read representative sequences</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(aviti_export, <span class="st">"taxa.rds"</span>))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>repseq <span class="ot">&lt;-</span> <span class="fu">DNAStringSet</span>(<span class="fu">rownames</span>(taxa))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify taxonomy table</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>taxtable <span class="ot">&lt;-</span> taxa</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxtable) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ASV"</span>, <span class="fu">seq</span>(<span class="fu">nrow</span>(taxtable)))</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(taxtable) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Kingdom"</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, <span class="st">"Family"</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Genus"</span>, <span class="st">"Species"</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify counts table</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>assay_data <span class="ot">&lt;-</span> seqtab.nochim</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(assay_data) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ASV"</span>, <span class="fu">seq</span>(<span class="fu">ncol</span>(assay_data)))</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm that order of samples is same in assay data and metadata!</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(assay_data) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>assay_data <span class="ot">&lt;-</span> <span class="fu">t</span>(assay_data)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Tse object</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">TreeSummarizedExperiment</span>(<span class="at">assays =</span> <span class="fu">list</span>(<span class="at">counts =</span> assay_data),</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>                                <span class="at">rowData =</span> taxtable,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>                                <span class="at">colData =</span> samples_meta)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="fu">referenceSeq</span>(tse) <span class="ot">&lt;-</span> repseq</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>tse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: TreeSummarizedExperiment 
dim: 6055 14 
metadata(0):
assays(1): counts
rownames(6055): ASV1 ASV2 ... ASV6054 ASV6055
rowData names(7): Kingdom Phylum ... Genus Species
colnames(14): A153 A154 ... A165 A166
colData names(8): Sampleid Sample_name ... DNA_concentration
  Culture_result
reducedDimNames(0):
mainExpName: NULL
altExpNames(0):
rowLinks: NULL
rowTree: NULL
colLinks: NULL
colTree: NULL
referenceSeq: a DNAStringSet (6055 sequences)</code></pre>
</div>
</div>
<p></p>
<p>Removal of non-bacterial, mitochondrial and clhloroplastic ASV’s</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASV that are bacteria or archaea</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> tse[<span class="fu">rowData</span>(tse)<span class="sc">$</span>Kingdom <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bacteria"</span>, <span class="st">"Archaea"</span>)]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASV that are not mitochondrial, keep emtpty</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> tse[<span class="fu">rowData</span>(tse)<span class="sc">$</span>Family <span class="sc">!=</span> <span class="st">"Mitochondria"</span> <span class="sc">|</span> <span class="fu">is.na</span>(<span class="fu">rowData</span>(tse)<span class="sc">$</span>Family)]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASV that are not chloroplastic, keep empty</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> tse[<span class="fu">rowData</span>(tse)<span class="sc">$</span>Order <span class="sc">!=</span> <span class="st">"Chloroplast"</span> <span class="sc">|</span> <span class="fu">is.na</span>(<span class="fu">rowData</span>(tse)<span class="sc">$</span>Order)]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Final dimensions</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(tse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5599   14</code></pre>
</div>
</div>
<p></p>
</section>
<section id="write-final-object-into-files" class="level4">
<h4 class="anchored" data-anchor-id="write-final-object-into-files">Write final object into files</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tse, (<span class="fu">paste0</span>(aviti_export,<span class="st">"tse.rds"</span>)))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Save representative sequences as fasta</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>tse <span class="sc">%&gt;%</span> <span class="fu">referenceSeq</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeXStringSet</span>(<span class="fu">paste0</span>(aviti_export,<span class="st">"repseq.fasta"</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">compress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">format =</span> <span class="st">"fasta"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save taxonomy table as tsv</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>taxfile <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rowData</span>(tse))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>taxfile <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"Variant"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_tsv</span>(<span class="at">file =</span> <span class="fu">paste0</span>(aviti_export, <span class="st">"taxonomy.tsv"</span>))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Save abundance table as tsv</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>ASV_counts <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">assays</span>(tse)<span class="sc">$</span>counts)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>ASV_counts <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span> <span class="st">"Variant"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(<span class="at">file =</span> <span class="fu">paste0</span>(aviti_export, <span class="st">"asv_table.tsv"</span>))</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Save metadata as tsv</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>metadf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Sampleid =</span> <span class="fu">rownames</span>(<span class="fu">colData</span>(tse)), <span class="fu">colData</span>(tse))</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(metadf, <span class="fu">paste0</span>(aviti_export, <span class="st">"metadata.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
</section>
<section id="miseq-read-processing" class="level3">
<h3 class="anchored" data-anchor-id="miseq-read-processing">MiSeq read processing</h3>
<section id="file-locations-and-variables-1" class="level4">
<h4 class="anchored" data-anchor-id="file-locations-and-variables-1">File locations and variables</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Paths</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>miseq <span class="ot">&lt;-</span> <span class="st">"miseq_reads/"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> <span class="st">"~/reference/silva_nr99_v138.2_toGenus_trainset.fa.gz"</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> <span class="st">"~/reference/silva_v138.2_assignSpecies.fa.gz"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>miseq_meta <span class="ot">&lt;-</span> <span class="st">"miseq_metadata.tsv"</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>miseq_export <span class="ot">&lt;-</span> <span class="st">"miseq_results/"</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Creates results directory</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(miseq_export)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>truncation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">260</span>,<span class="dv">200</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>meta_1stcol <span class="ot">&lt;-</span> <span class="st">"Sampleid"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="file-and-sample-lists-1" class="level4">
<h4 class="anchored" data-anchor-id="file-and-sample-lists-1">File and sample lists</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#List source files</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(miseq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "A001-MITY-F1_TR1.fastq.gz"  "A001-MITY-F1_TR2.fastq.gz" 
 [3] "A002-MITY-F2_TR1.fastq.gz"  "A002-MITY-F2_TR2.fastq.gz" 
 [5] "A003-MITY-F3_TR1.fastq.gz"  "A003-MITY-F3_TR2.fastq.gz" 
 [7] "A004-MITY-P1_TR1.fastq.gz"  "A004-MITY-P1_TR2.fastq.gz" 
 [9] "A005-MITY-P2_TR1.fastq.gz"  "A005-MITY-P2_TR2.fastq.gz" 
[11] "A006-MITY-W1_TR1.fastq.gz"  "A006-MITY-W1_TR2.fastq.gz" 
[13] "A007-MITY-W2_TR1.fastq.gz"  "A007-MITY-W2_TR2.fastq.gz" 
[15] "A008-MITY-W3_TR1.fastq.gz"  "A008-MITY-W3_TR2.fastq.gz" 
[17] "A009-MITY-T1_TR1.fastq.gz"  "A009-MITY-T1_TR2.fastq.gz" 
[19] "A010-MITY-T2_TR1.fastq.gz"  "A010-MITY-T2_TR2.fastq.gz" 
[21] "A011-MITY-WF1_TR1.fastq.gz" "A011-MITY-WF1_TR2.fastq.gz"
[23] "A012-MITY-WF2_TR1.fastq.gz" "A012-MITY-WF2_TR2.fastq.gz"
[25] "A013-MITY-C1_TR1.fastq.gz"  "A013-MITY-C1_TR2.fastq.gz" 
[27] "A014-MITY-Neg_TR1.fastq.gz" "A014-MITY-Neg_TR2.fastq.gz"
[29] "filtered"                  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward read names: SAMPLENAME_TR1.fastq</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>fnFwds <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(miseq, <span class="at">pattern =</span> <span class="st">"_TR1.fastq"</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reverse read names: SAMPLENAME_TR2.fastq</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>fnRevs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(miseq, <span class="at">pattern =</span> <span class="st">"_TR2.fastq"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract sample names</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>sample.names <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">basename</span>(fnFwds), <span class="st">"-"</span>), <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="read-quality-plots-1" class="level4">
<h4 class="anchored" data-anchor-id="read-quality-plots-1">Read quality plots</h4>
<p>Read quality from aggregated sequence data (200 000)</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>qfwd <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(fnFwds, <span class="at">aggregate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n =</span> <span class="fl">2e05</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(qfwd, <span class="at">file =</span> <span class="fu">paste0</span>(miseq_export, <span class="st">"qfwd.rds"</span>))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>qrev <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(fnRevs, <span class="at">aggregate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n =</span> <span class="fl">2e05</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(qrev, <span class="at">file =</span> <span class="fu">paste0</span>(miseq_export, <span class="st">"qrev.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plot forward and reverse read qualities. Data can be used to evaluate proper truncation length for filter and trim step.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>qfwd <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"qfwd.rds"</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>qrev <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"qrev.rds"</span>))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>qfwd <span class="ot">&lt;-</span> qfwd <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Forward reads"</span>) <span class="sc">+</span> <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>qrev <span class="ot">&lt;-</span> qrev <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Reverse reads"</span>) <span class="sc">+</span> <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>qfwd <span class="sc">+</span> qrev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/miseq_qplot-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p></p>
</section>
<section id="filter-and-trim-reads-1" class="level4">
<h4 class="anchored" data-anchor-id="filter-and-trim-reads-1">Filter and trim reads</h4>
<p>Create output lists for trim and filter function</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtered read files are placed in filtered subdirectory</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>filtFwds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(miseq, <span class="st">"filtered"</span>, <span class="fu">paste0</span>(sample.names,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"_F_filt.fastq.gz"</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>filtRevs <span class="ot">&lt;-</span> <span class="fu">file.path</span>(miseq, <span class="st">"filtered"</span>, <span class="fu">paste0</span>(sample.names,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"_R_filt.fastq.gz"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Execute the function</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Default parameters except truncLen and multithread</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">filterAndTrim</span>(fnFwds, filtFwds, fnRevs, filtRevs,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">truncLen =</span> truncation,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">maxN =</span> <span class="dv">0</span>, <span class="at">maxEE =</span> <span class="dv">2</span>, <span class="at">truncQ =</span> <span class="dv">2</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">compress =</span> <span class="cn">TRUE</span>, <span class="at">multithread =</span> <span class="dv">8</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">rm.phix =</span> phi)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save output object to file</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(out, <span class="fu">paste0</span>(miseq_export, <span class="st">"out.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="learn-error-rate-profiles" class="level4">
<h4 class="anchored" data-anchor-id="learn-error-rate-profiles">Learn error rate profiles</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward read error rate</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>errFwd <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtFwds, <span class="at">multithread =</span> <span class="dv">8</span>, <span class="at">randomize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reverse read error rate</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>errRev <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtRevs, <span class="at">multithread =</span> <span class="dv">8</span>, <span class="at">randomize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># save objects to files</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errFwd, <span class="fu">paste0</span>(miseq_export, <span class="st">"errFwd.rds"</span>))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errRev, <span class="fu">paste0</span>(miseq_export, <span class="st">"errRev.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plot error profiles</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>errFwd <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"errFwd.rds"</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting error rate profile for forward reads</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>plot_fwd <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errFwd, <span class="at">nominalQ=</span><span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">ggtitle</span> (<span class="st">"Forward"</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>errRev <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"errRev.rds"</span>))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting error rate profile for reverse reads</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>plot_rev <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errRev, <span class="at">nominalQ=</span><span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Reverse"</span>) <span class="sc">+</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">18</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>plot_fwd<span class="sc">/</span>plot_rev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/miseq_eplots-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p></p>
</section>
<section id="denoise-reads-1" class="level4">
<h4 class="anchored" data-anchor-id="denoise-reads-1">Denoise reads</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Denoise both forward and reverse reverse read using error rate profiles</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>dadaFwds <span class="ot">&lt;-</span> <span class="fu">dada</span>(filtFwds, <span class="at">err =</span> errFwd, <span class="at">multithread =</span> <span class="dv">8</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>dadaRevs <span class="ot">&lt;-</span> <span class="fu">dada</span>(filtRevs, <span class="at">err =</span> errRev, <span class="at">multithread =</span> <span class="dv">8</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save objects to files</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dadaFwds, <span class="fu">paste0</span>(miseq_export, <span class="st">"dadaFwds.rds"</span>))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dadaRevs, <span class="fu">paste0</span>(miseq_export, <span class="st">"dadaRevs.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="merge-reads-1" class="level4">
<h4 class="anchored" data-anchor-id="merge-reads-1">Merge reads</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dadaFwds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"dadaFwds.rds"</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>dadaRevs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"dadaRevs.rds"</span>))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge denoised paired-end reads</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">mergePairs</span>(dadaFwds, filtFwds, dadaRevs, filtRevs,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object to a file</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(merged, <span class="fu">paste0</span>(miseq_export, <span class="st">"merged.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="build-asv-table-1" class="level4">
<h4 class="anchored" data-anchor-id="build-asv-table-1">Build ASV table</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"merged.rds"</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sequence table. Rownames are sequences, colnames samples</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>seqtab <span class="ot">&lt;-</span> <span class="fu">makeSequenceTable</span>(merged)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions of ASV table</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(seqtab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   14 6090</code></pre>
</div>
</div>
<p></p>
<p>Remove chimeric variants</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">removeBimeraDenovo</span>(seqtab, <span class="at">method =</span> <span class="st">"consensus"</span>,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(seqtab.nochim)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object to a file</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(seqtab.nochim, <span class="fu">paste0</span>(miseq_export, <span class="st">"seqtabnochim.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plot ASV length distribution (relative abundance is not accounted for)</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"seqtabnochim.rds"</span>))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect sequence length distributions</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>asv_lengths <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">length =</span> <span class="fu">nchar</span>(<span class="fu">colnames</span>(seqtab.nochim)))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(asv_lengths, <span class="fu">aes</span>(<span class="at">x =</span> length)) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"orangered"</span>) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ASV length Distribution"</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Merged Length (nt)"</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"No of Reads"</span>) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">300</span>,<span class="dv">500</span>) <span class="sc">+</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_pander</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/miseq_asv_length-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p></p>
</section>
<section id="a-denoising-summary-table-1" class="level4">
<h4 class="anchored" data-anchor-id="a-denoising-summary-table-1">A denoising summary table</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read all objects from files</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"out.rds"</span>))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>dadaFwds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"dadaFwds.rds"</span>))</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>dadaRevs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"dadaRevs.rds"</span>))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"merged.rds"</span>))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"seqtabnochim.rds"</span>))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get values for each sample</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>getN <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">getUniques</span>(x))</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>track <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out, <span class="fu">sapply</span>(dadaFwds, getN), <span class="fu">sapply</span>(dadaRevs, getN),</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>               <span class="fu">sapply</span>(merged, getN), <span class="fu">rowSums</span>(seqtab.nochim),</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rowSums</span>(seqtab.nochim <span class="sc">!=</span> <span class="dv">0</span>))</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># If processing a single sample, remove the sapply calls: e.g.</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co"># replace sapply(dadaFs, getN) with getN(dadaFs)</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace column names</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(track) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Input"</span>, <span class="st">"Filtered"</span>, <span class="st">"DenoisedF"</span>, <span class="st">"DenoisedR"</span>,</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Merged"</span>, <span class="st">"Non-chimeric"</span>,<span class="st">"Variants"</span>)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace row names</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(track) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Table</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(track, <span class="at">format =</span> <span class="st">"html"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Input</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Filtered</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DenoisedF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DenoisedR</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Merged</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Non-chimeric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Variants</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A001</td>
<td style="text-align: right;">243336</td>
<td style="text-align: right;">223101</td>
<td style="text-align: right;">222609</td>
<td style="text-align: right;">222687</td>
<td style="text-align: right;">221667</td>
<td style="text-align: right;">217243</td>
<td style="text-align: right;">1613</td>
</tr>
<tr class="even">
<td style="text-align: left;">A002</td>
<td style="text-align: right;">122554</td>
<td style="text-align: right;">112095</td>
<td style="text-align: right;">112029</td>
<td style="text-align: right;">112086</td>
<td style="text-align: right;">111976</td>
<td style="text-align: right;">110787</td>
<td style="text-align: right;">367</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A003</td>
<td style="text-align: right;">277046</td>
<td style="text-align: right;">253661</td>
<td style="text-align: right;">253184</td>
<td style="text-align: right;">253420</td>
<td style="text-align: right;">252177</td>
<td style="text-align: right;">247004</td>
<td style="text-align: right;">1520</td>
</tr>
<tr class="even">
<td style="text-align: left;">A004</td>
<td style="text-align: right;">201678</td>
<td style="text-align: right;">185475</td>
<td style="text-align: right;">185303</td>
<td style="text-align: right;">185366</td>
<td style="text-align: right;">185055</td>
<td style="text-align: right;">182953</td>
<td style="text-align: right;">940</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A005</td>
<td style="text-align: right;">240109</td>
<td style="text-align: right;">220104</td>
<td style="text-align: right;">219735</td>
<td style="text-align: right;">219897</td>
<td style="text-align: right;">219175</td>
<td style="text-align: right;">217148</td>
<td style="text-align: right;">1001</td>
</tr>
<tr class="even">
<td style="text-align: left;">A006</td>
<td style="text-align: right;">183994</td>
<td style="text-align: right;">168327</td>
<td style="text-align: right;">168247</td>
<td style="text-align: right;">168314</td>
<td style="text-align: right;">168137</td>
<td style="text-align: right;">164562</td>
<td style="text-align: right;">245</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A007</td>
<td style="text-align: right;">105474</td>
<td style="text-align: right;">94935</td>
<td style="text-align: right;">94878</td>
<td style="text-align: right;">94932</td>
<td style="text-align: right;">94807</td>
<td style="text-align: right;">94304</td>
<td style="text-align: right;">174</td>
</tr>
<tr class="even">
<td style="text-align: left;">A008</td>
<td style="text-align: right;">25390</td>
<td style="text-align: right;">23294</td>
<td style="text-align: right;">23283</td>
<td style="text-align: right;">23288</td>
<td style="text-align: right;">23281</td>
<td style="text-align: right;">23278</td>
<td style="text-align: right;">30</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A009</td>
<td style="text-align: right;">168375</td>
<td style="text-align: right;">154767</td>
<td style="text-align: right;">154722</td>
<td style="text-align: right;">154718</td>
<td style="text-align: right;">154578</td>
<td style="text-align: right;">153720</td>
<td style="text-align: right;">274</td>
</tr>
<tr class="even">
<td style="text-align: left;">A010</td>
<td style="text-align: right;">329110</td>
<td style="text-align: right;">301440</td>
<td style="text-align: right;">301159</td>
<td style="text-align: right;">301329</td>
<td style="text-align: right;">300433</td>
<td style="text-align: right;">297177</td>
<td style="text-align: right;">589</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A011</td>
<td style="text-align: right;">420801</td>
<td style="text-align: right;">384943</td>
<td style="text-align: right;">384113</td>
<td style="text-align: right;">384659</td>
<td style="text-align: right;">383100</td>
<td style="text-align: right;">377289</td>
<td style="text-align: right;">892</td>
</tr>
<tr class="even">
<td style="text-align: left;">A012</td>
<td style="text-align: right;">264561</td>
<td style="text-align: right;">243988</td>
<td style="text-align: right;">243859</td>
<td style="text-align: right;">243935</td>
<td style="text-align: right;">243447</td>
<td style="text-align: right;">241561</td>
<td style="text-align: right;">472</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A013</td>
<td style="text-align: right;">1494</td>
<td style="text-align: right;">1354</td>
<td style="text-align: right;">1313</td>
<td style="text-align: right;">1328</td>
<td style="text-align: right;">1281</td>
<td style="text-align: right;">1275</td>
<td style="text-align: right;">56</td>
</tr>
<tr class="even">
<td style="text-align: left;">A014</td>
<td style="text-align: right;">1636</td>
<td style="text-align: right;">1508</td>
<td style="text-align: right;">1504</td>
<td style="text-align: right;">1505</td>
<td style="text-align: right;">1504</td>
<td style="text-align: right;">1504</td>
<td style="text-align: right;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
<p></p>
</section>
<section id="assign-taxonomy-1" class="level4">
<h4 class="anchored" data-anchor-id="assign-taxonomy-1">Assign taxonomy</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"seqtabnochim.rds"</span>))</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign taxa up to genus level</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">assignTaxonomy</span>(seqtab.nochim, training, <span class="at">multithread =</span> <span class="dv">10</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign species that are perfectly matched </span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">addSpecies</span>(taxa, species)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object to a file</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(taxa, <span class="fu">paste0</span>(miseq_export, <span class="st">"taxa.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="treesummarizedexperiment-object-1" class="level4">
<h4 class="anchored" data-anchor-id="treesummarizedexperiment-object-1">TreeSummarizedExperiment object</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read project metadata file</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>samples_meta <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(miseq_meta)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read representative sequences</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(miseq_export, <span class="st">"taxa.rds"</span>))</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>repseq <span class="ot">&lt;-</span> <span class="fu">DNAStringSet</span>(<span class="fu">rownames</span>(taxa))</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify taxonomy table</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>taxtable <span class="ot">&lt;-</span> taxa</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxtable) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ASV"</span>, <span class="fu">seq</span>(<span class="fu">nrow</span>(taxtable)))</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(taxtable) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Kingdom"</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, <span class="st">"Family"</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Genus"</span>, <span class="st">"Species"</span>)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify counts table</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>assay_data <span class="ot">&lt;-</span> seqtab.nochim</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(assay_data) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ASV"</span>, <span class="fu">seq</span>(<span class="fu">ncol</span>(assay_data)))</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm that order of samples is same in assay data and metadata!</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(assay_data) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>assay_data <span class="ot">&lt;-</span> <span class="fu">t</span>(assay_data)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Tse object</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">TreeSummarizedExperiment</span>(<span class="at">assays =</span> <span class="fu">list</span>(<span class="at">counts =</span> assay_data),</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>                                <span class="at">rowData =</span> taxtable,</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>                                <span class="at">colData =</span> samples_meta)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="fu">referenceSeq</span>(tse) <span class="ot">&lt;-</span> repseq</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>tse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: TreeSummarizedExperiment 
dim: 5703 14 
metadata(0):
assays(1): counts
rownames(5703): ASV1 ASV2 ... ASV5702 ASV5703
rowData names(7): Kingdom Phylum ... Genus Species
colnames(14): A001 A002 ... A013 A014
colData names(8): Sampleid Sample_name ... DNA_concentration
  Culture_result
reducedDimNames(0):
mainExpName: NULL
altExpNames(0):
rowLinks: NULL
rowTree: NULL
colLinks: NULL
colTree: NULL
referenceSeq: a DNAStringSet (5703 sequences)</code></pre>
</div>
</div>
<p></p>
<p>Removal of non-bacterial, mitochondrial and clhloroplastic ASV’s</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASV that are bacteria or archaea</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> tse[<span class="fu">rowData</span>(tse)<span class="sc">$</span>Kingdom <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bacteria"</span>, <span class="st">"Archaea"</span>)]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASV that are not mitochondrial, keep emtpty</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> tse[<span class="fu">rowData</span>(tse)<span class="sc">$</span>Family <span class="sc">!=</span> <span class="st">"Mitochondria"</span> <span class="sc">|</span> <span class="fu">is.na</span>(<span class="fu">rowData</span>(tse)<span class="sc">$</span>Family)]</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASV that are not chloroplastic, keep empty</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> tse[<span class="fu">rowData</span>(tse)<span class="sc">$</span>Order <span class="sc">!=</span> <span class="st">"Chloroplast"</span> <span class="sc">|</span> <span class="fu">is.na</span>(<span class="fu">rowData</span>(tse)<span class="sc">$</span>Order)]</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Final dimensions</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(tse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5331   14</code></pre>
</div>
</div>
<p></p>
</section>
<section id="write-final-object-into-files-1" class="level4">
<h4 class="anchored" data-anchor-id="write-final-object-into-files-1">Write final object into files</h4>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save object</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tse, (<span class="fu">paste0</span>(miseq_export,<span class="st">"tse.rds"</span>)))</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Save representative sequences as fasta</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>tse <span class="sc">%&gt;%</span> <span class="fu">referenceSeq</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeXStringSet</span>(<span class="fu">paste0</span>(miseq_export,<span class="st">"repseq.fasta"</span>),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">compress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">format =</span> <span class="st">"fasta"</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save taxonomy table as tsv</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>taxfile <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rowData</span>(tse))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>taxfile <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"Variant"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_tsv</span>(<span class="at">file =</span> <span class="fu">paste0</span>(miseq_export, <span class="st">"taxonomy.tsv"</span>))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Save abundance table as tsv</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>ASV_counts <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">assays</span>(tse)<span class="sc">$</span>counts)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>ASV_counts <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span> <span class="st">"Variant"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(<span class="at">file =</span> <span class="fu">paste0</span>(miseq_export, <span class="st">"asv_table.tsv"</span>))</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Save metadata as tsv</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>metadf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Sampleid =</span> <span class="fu">rownames</span>(<span class="fu">colData</span>(tse)), <span class="fu">colData</span>(tse))</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(metadf, <span class="fu">paste0</span>(miseq_export, <span class="st">"metadata.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
</section>
<section id="comparison-between-two-sequencing-platforms" class="level3">
<h3 class="anchored" data-anchor-id="comparison-between-two-sequencing-platforms">Comparison between two sequencing platforms</h3>
<p>In order to make direct comparison, it’s necessary to merge dada2 results.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Platform specific sequence tables</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>aviti_seqtab <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"aviti_results/seqtabnochim.rds"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>miseq_seqtab <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"miseq_results/seqtabnochim.rds"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join metadata</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>aviti_meta <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"aviti_metadata.tsv"</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>miseq_meta <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"miseq_metadata.tsv"</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">rbind</span>(aviti_meta,miseq_meta)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace Sampleid by Sample_name value</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>anames <span class="ot">&lt;-</span> aviti_meta<span class="sc">$</span>Sample_name</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>mnames <span class="ot">&lt;-</span> miseq_meta<span class="sc">$</span>Sample_name</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(aviti_seqtab) <span class="ot">&lt;-</span> anames</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(miseq_seqtab) <span class="ot">&lt;-</span> mnames</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge ASV tables</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>full_seqtab <span class="ot">&lt;-</span> <span class="fu">mergeSequenceTables</span>(aviti_seqtab, miseq_seqtab)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Reassign taxonmy</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">assignTaxonomy</span>(full_seqtab, training, <span class="at">multithread =</span> <span class="dv">10</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">addSpecies</span>(taxa, species)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Representative sequences</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>repseq <span class="ot">&lt;-</span> <span class="fu">DNAStringSet</span>(<span class="fu">rownames</span>(taxa))</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Taxonomy</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>taxtable <span class="ot">&lt;-</span> taxa</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxtable) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ASV"</span>, <span class="fu">seq</span>(<span class="fu">nrow</span>(taxtable)))</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(taxtable) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Kingdom"</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, <span class="st">"Family"</span>,</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Genus"</span>, <span class="st">"Species"</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Abundanes table</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>assay_data <span class="ot">&lt;-</span> full_seqtab</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(assay_data) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ASV"</span>,</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">seq</span>(<span class="fu">ncol</span>(assay_data)))</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure that order of samples is same in assay data and metadata</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(assay_data) <span class="ot">&lt;-</span> combined<span class="sc">$</span>Sample_name</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>assay_data <span class="ot">&lt;-</span> <span class="fu">t</span>(assay_data)</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Tse object</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>full_tse <span class="ot">&lt;-</span> <span class="fu">TreeSummarizedExperiment</span>(<span class="at">assays =</span> <span class="fu">list</span>(<span class="at">counts =</span> assay_data),</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>                                <span class="at">rowData =</span> taxtable,</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>                                <span class="at">colData =</span> combined)</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="fu">referenceSeq</span>(full_tse) <span class="ot">&lt;-</span> repseq</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter non-bacterial variants</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>full_tse <span class="ot">&lt;-</span> full_tse[<span class="fu">rowData</span>(full_tse)<span class="sc">$</span>Kingdom <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bacteria"</span>, <span class="st">"Archaea"</span>)]</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>full_tse <span class="ot">&lt;-</span> full_tse[<span class="fu">rowData</span>(full_tse)<span class="sc">$</span>Family <span class="sc">!=</span> <span class="st">"Mitochondria"</span> <span class="sc">|</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">is.na</span>(<span class="fu">rowData</span>(full_tse)<span class="sc">$</span>Family)]</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>full_tse <span class="ot">&lt;-</span> full_tse[<span class="fu">rowData</span>(full_tse)<span class="sc">$</span>Order <span class="sc">!=</span> <span class="st">"Chloroplast"</span> <span class="sc">|</span></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">is.na</span>(<span class="fu">rowData</span>(full_tse)<span class="sc">$</span>Order)]</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions</span></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>full_tse</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Save new object to a file</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(full_tse, <span class="st">"full_tse.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Basic statistics of the merged data set</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>full_tse <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"full_tse.rds"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(full_tse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5889   28</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample by platform</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(full_tse<span class="sc">$</span>Platform)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Aviti Miseq 
   14    14 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read statistics</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">colSums</span>(<span class="fu">assay</span>(full_tse)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    398   92597  144402  155585  207707  408352 </code></pre>
</div>
</div>
<p></p>
<p>Rarefaction to 88000 reads. Step removes 3 samples from both platforms</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rarefy data</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>tse_rar <span class="ot">&lt;-</span> <span class="fu">rarefyAssay</span>(full_tse, <span class="at">min_size =</span> <span class="dv">88000</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">replace =</span> <span class="cn">FALSE</span>, <span class="at">name =</span> <span class="st">"counts2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Stress test indicates that 2D NMDS is a faithful representation of dissimilarity analysis results.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bray-Curtis dissimilarity</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>nmds <span class="ot">&lt;-</span> <span class="fu">metaMDS</span>(<span class="fu">t</span>(<span class="fu">assay</span>(tse_rar, <span class="st">"counts2"</span>)), <span class="at">distance =</span> <span class="st">"bray"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Square root transformation
Wisconsin double standardization
Run 0 stress 0.08083425 
Run 1 stress 0.09482953 
Run 2 stress 0.0938446 
Run 3 stress 0.09384451 
Run 4 stress 0.09661411 
Run 5 stress 0.08083426 
... Procrustes: rmse 2.694851e-05  max resid 5.413506e-05 
... Similar to previous best
Run 6 stress 0.09661414 
Run 7 stress 0.1202968 
Run 8 stress 0.09894866 
Run 9 stress 0.09831597 
Run 10 stress 0.09894866 
Run 11 stress 0.08083425 
... New best solution
... Procrustes: rmse 2.84408e-06  max resid 5.716252e-06 
... Similar to previous best
Run 12 stress 0.1053973 
Run 13 stress 0.0938444 
Run 14 stress 0.08083425 
... Procrustes: rmse 4.11207e-06  max resid 8.899759e-06 
... Similar to previous best
Run 15 stress 0.08083863 
... Procrustes: rmse 0.0006905038  max resid 0.00228603 
... Similar to previous best
Run 16 stress 0.1205123 
Run 17 stress 0.09894867 
Run 18 stress 0.09482955 
Run 19 stress 0.09482006 
Run 20 stress 0.08083431 
... Procrustes: rmse 0.0001190623  max resid 0.0002468189 
... Similar to previous best
*** Best solution repeated 4 times</code></pre>
</div>
</div>
<p></p>
<p>Bray-Curtis NMDS plot between platforms maps same samples close to each other</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract NMDS scores (sites)</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>nmds_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(nmds<span class="sc">$</span>points)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add metadata (sample names &amp; platform)</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>nmds_df<span class="sc">$</span>Sample_name <span class="ot">&lt;-</span> <span class="fu">colData</span>(tse_rar)<span class="sc">$</span>Sample_name</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>nmds_df<span class="sc">$</span>Platform    <span class="ot">&lt;-</span> <span class="fu">colData</span>(tse_rar)<span class="sc">$</span>Platform</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure grouping is factor</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>nmds_df<span class="sc">$</span>Platform <span class="ot">&lt;-</span> <span class="fu">factor</span>(nmds_df<span class="sc">$</span>Platform, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Aviti"</span>, <span class="st">"Miseq"</span>))</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(nmds_df, <span class="fu">aes</span>(MDS1, MDS2, <span class="at">color =</span> Platform)) <span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> Sample_name),</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max.overlaps =</span> <span class="cn">Inf</span>,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">box.padding =</span> <span class="fl">0.4</span>,</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">point.padding =</span> <span class="fl">0.3</span>,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">segment.alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"orangered"</span>)) <span class="sc">+</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_pander</span>() <span class="sc">+</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>)</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"NMDS1"</span>, <span class="at">y =</span> <span class="st">"NMDS2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/bray-curtis-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p></p>
<p>Permanova analysis</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">vegdist</span>(<span class="fu">t</span>(<span class="fu">assay</span>(tse_rar, <span class="st">"counts2"</span>)), <span class="at">method=</span><span class="st">"bray"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adonis2</span>(d <span class="sc">~</span> Platform, <span class="at">data =</span> <span class="fu">colData</span>(tse_rar))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 999

adonis2(formula = d ~ Platform, data = colData(tse_rar))
         Df SumOfSqs      R2      F Pr(&gt;F)
Model     1   0.0881 0.01392 0.2822  0.994
Residual 20   6.2439 0.98608              
Total    21   6.3320 1.00000              </code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check dispersion</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>bd <span class="ot">&lt;-</span> <span class="fu">betadisper</span>(d, <span class="fu">colData</span>(tse_rar)<span class="sc">$</span>Platform)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">permutest</span>(bd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Permutation test for homogeneity of multivariate dispersions
Permutation: free
Number of permutations: 999

Response: Distances
          Df   Sum Sq   Mean Sq      F N.Perm Pr(&gt;F)
Groups     1 0.000134 0.0001343 0.0313    999  0.859
Residuals 20 0.085913 0.0042957                     </code></pre>
</div>
</div>
<p></p>
<p><strong>Analysis results:</strong></p>
<ul>
<li><p><strong>R² = 0.014</strong> Platform explains only about 1.4% of the variation in your microbial communities.</p></li>
<li><p><strong>P-value = 0.993</strong>: This is not statistically significant.</p></li>
<li><p><strong>Dispersion analysis p-value = 0.856.</strong>: Not significant and homogenuity requirements are fulfilled.</p></li>
</ul>
<p>Alpha diversity results show perfect correlation between two platforms</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate alpha diversity</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>alpha_div <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sample_name =</span> <span class="fu">colData</span>(tse_rar)<span class="sc">$</span>Sample_name,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Platform =</span> <span class="fu">colData</span>(tse_rar)<span class="sc">$</span>Platform,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Shannon =</span> <span class="fu">diversity</span>(<span class="fu">t</span>(<span class="fu">assay</span>(tse_rar, <span class="st">"counts2"</span>)), <span class="at">index =</span> <span class="st">"shannon"</span>),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Observed =</span> <span class="fu">colSums</span>(<span class="fu">assay</span>(tse_rar, <span class="st">"counts2"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Split sample_names by underscore</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>alpha_div<span class="sc">$</span>Sample_name <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*_"</span>, <span class="st">""</span>, alpha_div<span class="sc">$</span>Sample_name)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Split by platform</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>aviti_alpha <span class="ot">&lt;-</span> alpha_div[alpha_div<span class="sc">$</span>Platform <span class="sc">==</span> <span class="st">"Aviti"</span>, ]</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>miseq_alpha <span class="ot">&lt;-</span> alpha_div[alpha_div<span class="sc">$</span>Platform <span class="sc">==</span> <span class="st">"Miseq"</span>, ]</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Match samples by Sample_name</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>miseq_alpha <span class="ot">&lt;-</span> miseq_alpha[<span class="fu">match</span>(aviti_alpha<span class="sc">$</span>Sample_name, miseq_alpha<span class="sc">$</span>Sample_name), ]</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape for plotting</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>alpha_long <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Sample_name =</span> aviti_alpha<span class="sc">$</span>Sample_name, </span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">Platform =</span> <span class="st">"Aviti"</span>, </span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">Shannon =</span> aviti_alpha<span class="sc">$</span>Shannon,</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">Observed =</span> aviti_alpha<span class="sc">$</span>Observed),</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Sample_name =</span> miseq_alpha<span class="sc">$</span>Sample_name, </span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">Platform =</span> <span class="st">"Miseq"</span>, </span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">Shannon =</span> miseq_alpha<span class="sc">$</span>Shannon,</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">Observed =</span> miseq_alpha<span class="sc">$</span>Observed)</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Alpha diversity correlation</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">Aviti =</span> aviti_alpha<span class="sc">$</span>Shannon, </span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>                        <span class="at">MiSeq =</span> miseq_alpha<span class="sc">$</span>Shannon),</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> Aviti, <span class="at">y =</span> MiSeq)) <span class="sc">+</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"orangered1"</span>) <span class="sc">+</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_cor</span>(<span class="at">method =</span> <span class="st">"pearson"</span>, <span class="at">label.x =</span> <span class="fl">3.8</span>, <span class="at">label.y =</span> <span class="fl">6.5</span>) <span class="sc">+</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_few</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Shannon Diversity"</span>, <span class="at">x =</span> <span class="st">"Aviti"</span>, <span class="at">y =</span> <span class="st">"MiSeq"</span>) <span class="sc">+</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">Aviti =</span> aviti_alpha<span class="sc">$</span>Observed, </span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>                        <span class="at">MiSeq =</span> miseq_alpha<span class="sc">$</span>Observed),</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> Aviti, <span class="at">y =</span> MiSeq)) <span class="sc">+</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"orangered"</span>) <span class="sc">+</span></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_cor</span>(<span class="at">method =</span> <span class="st">"pearson"</span>, <span class="at">label.x =</span> <span class="dv">200</span>, <span class="at">label.y =</span> <span class="dv">1500</span>) <span class="sc">+</span></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_few</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Observed ASVs"</span>, <span class="at">x =</span> <span class="st">"Aviti"</span>, <span class="at">y =</span> <span class="st">"MiSeq"</span>) <span class="sc">+</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>p5 <span class="sc">|</span> p6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/alpha_diversity-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p></p>
<p>Shared and unique ASV’s between platforms</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get abundance data</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">assay</span>(tse_rar, <span class="st">"counts2"</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify samples by platform</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>aviti_samples <span class="ot">&lt;-</span> <span class="fu">which</span>(tse_rar<span class="sc">$</span>Platform <span class="sc">==</span> <span class="st">"Aviti"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>miseq_samples <span class="ot">&lt;-</span> <span class="fu">which</span>(tse_rar<span class="sc">$</span>Platform <span class="sc">==</span> <span class="st">"Miseq"</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ASVs present in each platform (considering all samples)</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>aviti_asvs <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowSums</span>(counts[, aviti_samples] <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>miseq_asvs <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowSums</span>(counts[, miseq_samples] <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify platform-specific ASVs (MOVED HERE - MUST BE BEFORE USING THEM)</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>aviti_only <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(aviti_asvs, miseq_asvs)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>miseq_only <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(miseq_asvs, aviti_asvs)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>shared <span class="ot">&lt;-</span> <span class="fu">intersect</span>(aviti_asvs, miseq_asvs)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary statistics</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== ASV Distribution Summary ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== ASV Distribution Summary ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total ASVs in Aviti:"</span>, <span class="fu">length</span>(aviti_asvs), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total ASVs in Aviti: 5519 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total ASVs in MiSeq:"</span>, <span class="fu">length</span>(miseq_asvs), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total ASVs in MiSeq: 5274 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Shared ASVs:"</span>, <span class="fu">length</span>(shared), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shared ASVs: 4988 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Aviti-only ASVs:"</span>, <span class="fu">length</span>(aviti_only), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Aviti-only ASVs: 531 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MiSeq-only ASVs:"</span>, <span class="fu">length</span>(miseq_only), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MiSeq-only ASVs: 286 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Percentage shared:"</span>, <span class="fu">round</span>(<span class="fu">length</span>(shared)<span class="sc">/</span><span class="fu">length</span>(<span class="fu">union</span>(aviti_asvs, miseq_asvs))<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Percentage shared: 85.9 %</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total abundance for each category</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>aviti_only_abundance <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[aviti_only, aviti_samples])</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>miseq_only_abundance <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[miseq_only, miseq_samples])</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>shared_abundance_aviti <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[shared, aviti_samples])</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>shared_abundance_miseq <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[shared, miseq_samples])</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate totals per platform</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>total_aviti <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[, aviti_samples])</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>total_miseq <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[, miseq_samples])</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text summary</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Abundance Distribution ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Abundance Distribution ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AVITI PLATFORM:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AVITI PLATFORM:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Total reads:"</span>, <span class="fu">format</span>(total_aviti, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Total reads: 968,000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Reads in shared ASVs:"</span>, <span class="fu">format</span>(shared_abundance_aviti, <span class="at">big.mark =</span> <span class="st">","</span>), </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"(%.2f%%)"</span>, shared_abundance_aviti<span class="sc">/</span>total_aviti <span class="sc">*</span> <span class="dv">100</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Reads in shared ASVs: 943,420 (97.46%) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Reads in Aviti-only ASVs:"</span>, <span class="fu">format</span>(aviti_only_abundance, <span class="at">big.mark =</span> <span class="st">","</span>), </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"(%.2f%%)"</span>, aviti_only_abundance<span class="sc">/</span>total_aviti <span class="sc">*</span> <span class="dv">100</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Reads in Aviti-only ASVs: 24,580 (2.54%) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MISEQ PLATFORM:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MISEQ PLATFORM:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Total reads:"</span>, <span class="fu">format</span>(total_miseq, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Total reads: 968,000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Reads in shared ASVs:"</span>, <span class="fu">format</span>(shared_abundance_miseq, <span class="at">big.mark =</span> <span class="st">","</span>), </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"(%.2f%%)"</span>, shared_abundance_miseq<span class="sc">/</span>total_miseq <span class="sc">*</span> <span class="dv">100</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Reads in shared ASVs: 949,334 (98.07%) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Reads in MiSeq-only ASVs:"</span>, <span class="fu">format</span>(miseq_only_abundance, <span class="at">big.mark =</span> <span class="st">","</span>), </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"(%.2f%%)"</span>, miseq_only_abundance<span class="sc">/</span>total_miseq <span class="sc">*</span> <span class="dv">100</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Reads in MiSeq-only ASVs: 18,666 (1.93%) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bar plot showing percentage breakdown</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>abundance_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Platform =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Aviti"</span>, <span class="st">"MiSeq"</span>), <span class="at">each =</span> <span class="dv">2</span>),</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Category =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Shared ASVs"</span>, <span class="st">"Platform-specific ASVs"</span>), <span class="dv">2</span>),</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Percentage =</span> <span class="fu">c</span>(</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    shared_abundance_aviti<span class="sc">/</span>total_aviti <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    aviti_only_abundance<span class="sc">/</span>total_aviti <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    shared_abundance_miseq<span class="sc">/</span>total_miseq <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    miseq_only_abundance<span class="sc">/</span>total_miseq <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Reads =</span> <span class="fu">c</span>(</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    shared_abundance_aviti,</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    aviti_only_abundance,</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    shared_abundance_miseq,</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    miseq_only_abundance</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(abundance_data, <span class="fu">aes</span>(<span class="at">x =</span> Platform, <span class="at">y =</span> Percentage, <span class="at">fill =</span> Category)) <span class="sc">+</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"stack"</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Shared ASVs"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, </span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Platform-specific ASVs"</span> <span class="ot">=</span> <span class="st">"orangered"</span>)) <span class="sc">+</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, Percentage)), </span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>), </span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Read Distribution by ASV Category"</span>,</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Percentage of Reads (%)"</span>,</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/shared_asv-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Euler diagram for ASV comparison</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>count_fit <span class="ot">&lt;-</span> <span class="fu">euler</span>(<span class="fu">c</span>(</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Aviti"</span> <span class="ot">=</span> <span class="fu">length</span>(aviti_only),           <span class="co"># ASVs unique to Aviti</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MiSeq"</span> <span class="ot">=</span> <span class="fu">length</span>(miseq_only),           <span class="co"># ASVs unique to MiSeq</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Aviti&amp;MiSeq"</span> <span class="ot">=</span> <span class="fu">length</span>(shared)          <span class="co"># ASVs shared between both</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with custom colors</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(count_fit,</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">fills =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"orangered"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">quantities =</span> <span class="cn">TRUE</span>,</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">labels =</span> <span class="fu">list</span>(<span class="at">cex =</span> <span class="fl">1.2</span>),</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"ASV Overlap Between Platforms"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dada2_pipeline_files/figure-html/shared_asv-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create detailed table for platform-specific ASVs</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>create_platform_table <span class="ot">&lt;-</span> <span class="cf">function</span>(asv_list, platform_name, tse_obj, platform_samples) {</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(asv_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">Message =</span> <span class="fu">paste</span>(<span class="st">"No"</span>, platform_name, <span class="st">"-specific ASVs found"</span>)))</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get taxonomy and abundance data</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>  tax_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rowData</span>(tse_obj)[asv_list, ])</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  counts_data <span class="ot">&lt;-</span> <span class="fu">assay</span>(tse_obj, <span class="st">"counts2"</span>)[asv_list, platform_samples,</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>                                           drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate statistics</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">ASV =</span> asv_list,</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    tax_data,</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Reads =</span> <span class="fu">rowSums</span>(counts_data),</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean_Abundance =</span> <span class="fu">rowMeans</span>(counts_data),</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Max_Abundance =</span> <span class="fu">apply</span>(counts_data, <span class="dv">1</span>, max),</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_Samples =</span> <span class="fu">rowSums</span>(counts_data <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by total reads (descending)</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> result[<span class="fu">order</span>(<span class="sc">-</span>result<span class="sc">$</span>Total_Reads), ]</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tables for platform-specific ASVs</span></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>aviti_table <span class="ot">&lt;-</span> <span class="fu">create_platform_table</span>(aviti_only, <span class="st">"Aviti"</span>, tse_rar, aviti_samples)</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>miseq_table <span class="ot">&lt;-</span> <span class="fu">create_platform_table</span>(miseq_only, <span class="st">"MiSeq"</span>, tse_rar, miseq_samples)</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze abundance of platform-specific ASVs</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">=== Abundance Analysis of Platform-Specific ASVs ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

=== Abundance Analysis of Platform-Specific ASVs ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>total_aviti_reads <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[, aviti_samples])</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>total_miseq_reads <span class="ot">&lt;-</span> <span class="fu">sum</span>(counts[, miseq_samples])</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>aviti_specific_reads <span class="ot">&lt;-</span> <span class="fu">sum</span>(aviti_table<span class="sc">$</span>Total_Reads)</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>miseq_specific_reads <span class="ot">&lt;-</span> <span class="fu">sum</span>(miseq_table<span class="sc">$</span>Total_Reads)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>abundance_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Platform =</span> <span class="fu">c</span>(<span class="st">"Aviti"</span>, <span class="st">"MiSeq"</span>),</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Platform_Specific_ASVs =</span> <span class="fu">c</span>(<span class="fu">length</span>(aviti_only), <span class="fu">length</span>(miseq_only)),</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Total_Reads_in_Specific =</span> <span class="fu">c</span>(aviti_specific_reads, miseq_specific_reads),</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Percent_of_Total_Reads =</span> <span class="fu">c</span>(</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(aviti_specific_reads<span class="sc">/</span>total_aviti_reads <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(miseq_specific_reads<span class="sc">/</span>total_miseq_reads <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(abundance_summary, <span class="at">format =</span> <span class="st">"html"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Platform</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Platform_Specific_ASVs</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Total_Reads_in_Specific</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Percent_of_Total_Reads</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Aviti</td>
<td style="text-align: right;">531</td>
<td style="text-align: right;">24580</td>
<td style="text-align: right;">2.54</td>
</tr>
<tr class="even">
<td style="text-align: left;">MiSeq</td>
<td style="text-align: right;">286</td>
<td style="text-align: right;">18666</td>
<td style="text-align: right;">1.93</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save full tables to files</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(aviti_table, <span class="st">"aviti_only_asvs.tsv"</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(miseq_table, <span class="st">"miseq_only_asvs.tsv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Finally, we calculate platform-specific ASVs after removing rare variants (n&lt;100).</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ASVs with total abundance &lt; 10 across all samples</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">assay</span>(tse_rar, <span class="st">"counts2"</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>abundant_asvs <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowSums</span>(counts) <span class="sc">&gt;=</span> <span class="dv">100</span>]</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Recalculate platform-specific ASVs with filtered data</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>aviti_asvs_filt <span class="ot">&lt;-</span> abundant_asvs[<span class="fu">rowSums</span>(counts[abundant_asvs, aviti_samples] <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>miseq_asvs_filt <span class="ot">&lt;-</span> abundant_asvs[<span class="fu">rowSums</span>(counts[abundant_asvs, miseq_samples] <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>shared_filt <span class="ot">&lt;-</span> <span class="fu">intersect</span>(aviti_asvs_filt, miseq_asvs_filt)</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>aviti_only_filt <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(aviti_asvs_filt, miseq_asvs_filt)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>miseq_only_filt <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(miseq_asvs_filt, aviti_asvs_filt)</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare results</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Before filtering (all ASVs) ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Before filtering (all ASVs) ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Shared:"</span>, <span class="fu">length</span>(shared), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shared: 4988 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Aviti-only:"</span>, <span class="fu">length</span>(aviti_only), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Aviti-only: 531 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MiSeq-only:"</span>, <span class="fu">length</span>(miseq_only), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MiSeq-only: 286 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Percent shared:"</span>, <span class="fu">round</span>(<span class="fu">length</span>(shared)<span class="sc">/</span><span class="fu">length</span>(<span class="fu">union</span>(aviti_asvs, miseq_asvs))<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Percent shared: 85.9 %</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== After filtering (total abundance &gt;= 100) ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== After filtering (total abundance &gt;= 100) ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Shared:"</span>, <span class="fu">length</span>(shared_filt), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shared: 2504 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Aviti-only:"</span>, <span class="fu">length</span>(aviti_only_filt), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Aviti-only: 30 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MiSeq-only:"</span>, <span class="fu">length</span>(miseq_only_filt), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MiSeq-only: 37 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Percent shared:"</span>, <span class="fu">round</span>(<span class="fu">length</span>(shared_filt)<span class="sc">/</span><span class="fu">length</span>(<span class="fu">union</span>(aviti_asvs_filt, miseq_asvs_filt))<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Percent shared: 97.4 %</code></pre>
</div>
</div>
<p></p>
<p>After filtering rare variants, &gt;90% of platform-specific variants were removed. This further supports the hypothesis that both platforms yield nearly identical results. It is also worth noting that a single nucleotide difference will render sequences as distinct ASVs.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>